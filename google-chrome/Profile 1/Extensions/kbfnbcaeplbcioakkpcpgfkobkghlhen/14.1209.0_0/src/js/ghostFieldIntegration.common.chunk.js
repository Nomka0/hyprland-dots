(self.webpackChunk=self.webpackChunk||[]).push([[748],{84275:(e,t,i)=>{i.r(t),i.d(t,{GhostFieldIntegration:()=>N});var s=i(90023),n=i(88570),r=i(56765),h=i(49144),a=i(55446),c=i(73863),o=i(17888),l=i(27628),_=i(65647),d=i(18615),p=i(58303),g=i(1607),u=i(52256),v=i(43636),b=i(25770),S=i(69342),x=i(23335),k=i(86185),C=i(42530),m=i(45661),f=i(43385),y=i(45439),T=i(39408),w=i(7958),D=i(76459),A=i(94671),F=i(98518),P=i(68760),E=i(34286),U=i(73930),B=i(37559),O=i(55604),R=i(42043),I=i(43227),M=i(88004),G=i(557),z=i(93453),H=i(90522),q=i(66472);class N{constructor({doc:e,textField:t,domain:i,layout:n,createCheckingService:o,state:l,gnar:_,felog:d,textObserver:g,experimentClient:u,createTextRevisionManager:v=(e=>M.n.create(e)),originalTextField:S=t,customizations:x={},mapChange:C=s.yR,integrationName:m,typingTracker:y}){this._initialSessionUUID=b.h.create(p.YP),this._disposables=[],this._checkingService=b.h.create(null),this._sduiBufferService=b.h.create(p.YP),this._publishedAckReceived=new h.X(!1),this._canDisposeCheckingService=new h.X(!1),this._canDisposeCheckingServicePromise=this._canDisposeCheckingService.pipe(a.h((e=>e)),c.q(1)).toPromise(),this._checkingStatus=b.h.create(E.H.idle),this._readyState=b.h.create(U.kQ.notReady),this._nativeSpellcheckEnabled=b.h.create(!1),this._generalScore=b.h.create(null),this._lowestGeneralScore=b.h.create(null),this._paragraphsCount=b.h.create(0),this._formattingSpansCount=b.h.create(0),this._requestAwaitService=new B.e,this._capiStartAckMessage=b.h.create(p.YP),this._isDisposed=!1,this._subs=[],this._domain=i,this._layout=n,this._createCheckingService=o,this._state=l,this._gnar=_,this._felog=d,this._textObserver=g,this._createTextRevisionManager=v,this._originalTextField=S,this._customizations=x,this._experimentClient=u,this._initialWebkitUserSelect=this._originalTextField.style.webkitUserSelect,this._mapChange=C,this._integrationName=m,this._textRevisionManager=this._createTextRevisionManager(g),this._disposables.push(this._textRevisionManager),this._disposables.push(this._alertProcessor),this._disposables.push(this._userEngagedByAlertsAcceptedService),this._doc=F.v.createOnCapi(e,{selectedLens:r.R.SpecialId.AllAlerts}),this._typingTracker=y;const T=this._state.get().dynamicConfig.dlpEnabled&&"enabled"===this._experimentClient.getTreatment(z.p.ClientControlsDlpBuffering),w=this._experimentClient.isGateEnabled(H.K.TextChangeBufferUseLegacy),P=this._textObserver.getCurrentTextMap().getPlainText();this._alertProcessor=f.B.create(P,this._textRevisionManager,d);const O=R.ft,G=w?new I.R(this.getUnmappedTextObserver().contentChanges.async,T?void 0:(0,k.qw)(this._originalTextField),!!this._customizations.richText,O):new R.fM(this.getUnmappedTextObserver().contentChanges.async,this._alertProcessor,T?void 0:(0,k.qw)(this._originalTextField),!!this._customizations.richText,O,!this._experimentClient.isGateEnabled(H.K.TextChangeBufferDontFlushOnApply));this._textChangeBuffer=G,this._disposables.push(G),this._textFieldAttrs=new D.Y(this._originalTextField,{spellcheck:"false"}),this._subs.push((0,A.H)({checkingService:this._checkingService,highlights:this._highlights,layout:this._layout,experimentClient:this._experimentClient,getAlertById:e=>this._alertProcessor.alerts.getAlertById(e)}).subscribe()),this._disposables.push(this._textFieldAttrs),Promise.resolve().then((()=>this._delayedStart()))}_isGBSigninCheckTextDisabled(){var e;const{user:t,page:i}=this._state.get();return(0,O.K)(t,i)&&(null!==(e=i.hideGBSigninPopupTodayTimestamp)&&void 0!==e?e:0)>Date.now()-g.pU}_delayedStart(){const{user:e,page:t}=this._state.get();q.n.isEdcBlocked(e)||this._isGBSigninCheckTextDisabled()||this._startCheckingText(!0===t.showOnboarding)}update(e){const t=this._checkingService.get();if(q.n.isEdcBlocked(e.user)||this._isGBSigninCheckTextDisabled())return null!==t&&(this._alertProcessor.removeAllAlerts({_tag:y.i.reset}),t.closeConnection(),this._checkingService.set(null)),void this._state.set(e);if(null!==t){const i=e.user,s=e.dapi.dialectStrong,n=this._state.get(),r=n.user,h=n.dapi.dialectStrong;i.id!==r.id||i.type!==r.type?(t.reconnect(),this._alertProcessor.removeAllAlerts({_tag:y.i.reset})):s!==h&&this._doc.settings.modify((e=>{const t={...e.context,dialect:p.ij(s)};return{...e,context:t}}))}else"ready"===e.extensionFSM.stage&&this._startCheckingText(!0===e.page.showOnboarding);this._state.set(e)}dispose(){var e;this._isDisposed||(this._isDisposed=!0,this._subs.forEach((e=>e.unsubscribe())),this._originalTextField.style.webkitUserSelect=this._initialWebkitUserSelect,[...this._disposables,this._textObserver,this._layout.textField.scroller].forEach((e=>{try{null==e||e.dispose()}catch(e){}})),null===(e=this._checkingService.get())||void 0===e||e.dispose(),o.timer(1e3).pipe(l.c(this._publishedAckReceived)).subscribe((e=>{e||this._canDisposeCheckingService.next(!0)})))}_startCheckingText(e){if(null!==this._checkingService.get())return;const t=this._createCheckingService({doc:this._doc,mapChange:this._mapChange,integrationName:this._integrationName});this._checkingService.set(t),t.delayDisposeUntil(this._canDisposeCheckingServicePromise),this._subs.push(t.capiMessages.pipe(a.h((e=>"start"===e.action))).subscribe((e=>this._capiStartAckMessage.set(p.G(e))))),this._subs.push(t.capiEvents.pipe(a.h(n.hX.is("session_started"))).subscribe((e=>{this._initialSessionUUID.set(p.ij(e.sessionUuid))})));this._typingTracker.then((e=>this._disposables.push(e.registerFieldIntegration(S.O.ghost,this._originalTextField,this._integrationName,this._textObserver)))),this._checkingFeatureImpl=new w.O(this._state.view("user"),this._alertProcessor,t,this.getUnmappedTextObserver(),this._textRevisionManager,(()=>{}),(e=>this._checkingStatus.set(e)),(e=>this._readyState.set(e)),(e=>{this._fieldIntegrationController.setSiteSettings(e),this._checkDocContextSubscription()}),(e=>{this._textFieldAttrs.setAttributes({spellcheck:e.toString()}),this._nativeSpellcheckEnabled.set(e)}),((e,t,i)=>{}),(e=>(0,s.zG)(u.cS)),!!this._customizations.richText,(e=>this._generalScore.set(e||null)),(e=>this._lowestGeneralScore.set(e||null)),(e=>this._paragraphsCount.set(e)),(e=>this._formattingSpansCount.set(e)),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(e=>{}),(()=>{(0,m.OB)().bgRpc.api.refreshUser("not_authorized")}),(e=>{this._statisticsService.wordsCount.set(e.wordsCount),this._statisticsService.charsCount.set(e.charsCount),this._statisticsService.sessionStats.set(e.sessionStats)}),(e=>{}),(e=>{}),(()=>this._canDisposeCheckingService.next(!0)),this._requestAwaitService.requests,this._textChangeBuffer,this._experimentClient,this._sduiBufferService.get(),new x.R),this.addSubscription(this._alertProcessor.alerts.state.pipe(_.U(T.S.alertMapToCapiAlerts),a.h((e=>e.filter((e=>e.isHidden)).length>0)),d.P()).subscribe((()=>{const{upgradeHookExperiment:e,experimentGroup:t}=(0,P.o)(this._experimentClient);this._felog.upgradeHooksExp.upgradeHookFirstHiddenPremiumAlertReceived(e.name,t,this._domain)}))),this._checkingFeatureImpl.delayDisposeUntil(this._canDisposeCheckingServicePromise)}getUnmappedTextObserver(){return this._textObserver}addSubscription(e){this._isDisposed?e.unsubscribe():this._subs.push(e)}_checkDocContextSubscription(){var e;this._customizations.getDocEvents&&(null===(e=this._docEventsSubscription)||void 0===e||e.unsubscribe(),this._docEventsSubscription=this._customizations.getDocEvents(this._originalTextField).subscribe((e=>{var t,i;switch(e.type){case"docContextUpdated":{const i=this._sanitizeContextInfo(e.docContextInfo);(0,v.Qr)(i)||null===(t=this._checkingService.get())||void 0===t||t.updateContextInfo(i);break}case"published":null===(i=this._checkingService.get())||void 0===i||i.published();break;default:(0,C.vE)(e)}})),this._subs.push(this._docEventsSubscription))}_sanitizeContextInfo(e){const t=Object.keys(e),i=q.n.isGrammarlyEmployee(this._state.view("user").get());return t.reduce(((e,t)=>(G.t.fieldIsPrivate(t)&&!i&&delete e[t],e)),e)}}}}]);