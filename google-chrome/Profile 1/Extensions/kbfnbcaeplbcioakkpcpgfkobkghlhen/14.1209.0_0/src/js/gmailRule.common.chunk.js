(self.webpackChunk=self.webpackChunk||[]).push([[1330],{17445:(e,t,i)=>{i.d(t,{c:()=>s});var n=i(90522);const s=e=>e.isGateEnabled(n.K.KnowledgeHubGmail)},35312:(e,t,i)=>{i.d(t,{q:()=>n});var n,s=i(11633),o=i(21147);!function(e){let t;!function(e){e.codec=s.UQ(s.Z_,(e=>"string"==typeof e),"AnnotationId"),e.create=function(e){return e},e.eq=o.yv}(t=e.Id||(e.Id={})),e.eq=o.MW({id:t.eq,span:o.MW({s:o.lr,e:o.lr})})}(n||(n={}))},1795:(e,t,i)=>{i.d(t,{Lu:()=>o,hX:()=>n,jA:()=>s});var n,s,o,r=i(68259);!function(e){e.create=function(e){return e}}(n||(n={})),function(e){let t,i;!function(e){e.start="start",e.error="error",e.updateContextInfoFinished="updateContextInfoFinished",e.docFinished="docFinished",e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),e.isUpdateContextInfoFinished=function(e){return e.kind===t.updateContextInfoFinished},e.isDocFinished=function(e){return e.kind===t.docFinished},function(e){let i;e.isItem=function(e){return e.kind===t.knowledgeHubItem},function(e){e.create=e=>e,e.toAlertId=e=>e}(i=e.ItemId||(e.ItemId={}))}(i=e.KnowledgeHub||(e.KnowledgeHub={})),e.isKnowledgeHub=i.isItem}(s||(s={})),(0,r.L0)(void 0),function(e){e.LOOKED="LOOKED",e.IGNORE="IGNORE"}(o||(o={}))},80144:(e,t,i)=>{i.d(t,{I:()=>n,n:()=>s});var n,s,o=i(68259),r=i(21147);!function(e){let t,i;!function(e){e.knowledgeHubItem="knowledgeHubItem"}(t=e.Kind||(e.Kind={})),function(e){e.isItem=function(e){return e.kind===t.knowledgeHubItem}}(i=e.KnowledgeHub||(e.KnowledgeHub={}))}(n||(n={})),(0,o.L0)(void 0),function(e){e.eq=r.yv}(s||(s={}))},19794:(e,t,i)=>{i.r(t),i.d(t,{Gmail:()=>qi,getSiblingsContextEventObservable:()=>$i});var n=i(58303),s=i(90023),o=i(82823),r=i(30152),a=i(90049),d=i(64965),c=i(65882),l=i(20715),u=i(74857),h=i(65647),g=i(43456),p=i(55446),m=i(34859),f=i(14765),b=i(60841),_=i(5657);const v={positionResetStyle:{visibility:"visible",zIndex:1e3}};var x=i(17445),w=i(62228),C=i(78488),y=i(6662),I=i(25989),S=i(8748),k=i(25770),E=i(88241),U=i(45661),N=i(45654);class A{constructor(e,t,n,s,a,d=U.OB,c=E.Y.create("gmail.knowledgeHub.pageIntegration")){this._csState=n,this._csActions=s,this._felog=a,this._getEnv=d,this._logger=c,this.type=N.M.generalPurpose,this._subscriptions=new o.w,this._knowledgeHubCSState=k.h.create(w.v3.get(this._csState.page.knowledgeHubSettings)),this._disposed=k.h.create(!1),this.disposed=this._disposed.view(),this._logger.info("Initing knowledgeHubIntegration",{csState:this._csState.page.knowledgeHubSettings}),this._subscriptions.add(this._knowledgeHubCSState.view((e=>e.enabled)).pipe(C.b((e=>this._logger.info("Integration state change. State: "+(e?"on":"off")))),b.w((n=>n?e.pipe(y.cp((({threadContext:e,checkingService:n,annotationsManager:o})=>I.D(Promise.all([i.e(3382),i.e(9571),i.e(1670),i.e(5689),i.e(6032),i.e(8513)]).then(i.bind(i,7380))).pipe(b.w((({createKnowledgeHubThreadIntegration:i})=>new r.y((()=>{const r=i(n,o,e,t,a,s,this._knowledgeHubCSState,this._getEnv);return()=>r()})))))))):S.E))).subscribe()),this._logger.debug("Page integration created")}update(e){this._logger.debug("Received cs state update",e),this._knowledgeHubCSState.set(w.v3.get(e.page.knowledgeHubSettings))}dispose(){this._disposed.set(!0),this._subscriptions.unsubscribe(),this._logger.debug("Page integration disposed")}}var G,z=i(79514),O=i(44025),M=i(80225),R=i(84639),T=i(89594),j=i(46808),L=i(99213),F=i(72925),q=i(55901),D=i(566),P=i(68599),V=i(92014),H=i(557),K=i(88900),W=i(92865),$=i(4623);!function(e){const t="gmail_quote";function i(e){return e.classList.contains(t)&&"DIV"===e.tagName}function n(e){return"BLOCKQUOTE"===(n=e).tagName&&n.classList.contains(t)||function(e){var i;return e.classList.contains("gmail_attr")&&(null===(i=e.parentElement)||void 0===i?void 0:i.classList.contains(t))}(e)||function(e){var t,n,s;return i(e)&&"-----"===(null===(s=null===(n=null===(t=e.firstElementChild)||void 0===t?void 0:t.firstChild)||void 0===n?void 0:n.textContent)||void 0===s?void 0:s.slice(0,5))}(e);var n}function s(e,t){return!(!$.Z.defaultFilterNodeAllowingBlockquote(e,t)||(i=e,"false"===i.getAttribute("contenteditable")&&!i.getAttribute("email")))&&!n(e);var i}function o(e,t){return n(e)?{...t,blockquote:!0}:"BLOCKQUOTE"===e.tagName?{...t}:"gmail_signature"===(i=e).getAttribute("data-smartmail")||i.classList.contains("gmail_signature")?{...t,signature:!0}:$.Z.defaultNodeFormatting(e,t);var i}e.maybeGmailHistoryQuote=i,e.gmailNodeFormatting=o,e.createTextMap=e=>new $.Z(e,s,void 0,void 0,void 0,void 0,void 0,o)}(G||(G={}));var B=i(65233),Y=i(52073),Q=i(16711),X=i(90522),Z=i(79409),J=i(50293),ee=i(24202),te=i(86399),ie=i(92135),ne=i(38131),se=i(31413),oe=i(60165),re=i(53710),ae=i(12518),de=i(58623),ce=i(66738),le=i(36072),ue=i(13195),he=i(85782),ge=i(12171),pe=i(1941),me=i(69715),fe=i(17071),be=i(52256),_e=i(21147),ve=i(68259),xe=i(1795);function we(e){return(t,i)=>o=>(0,s.zG)(o,de.cq(e)(t,(0,s.ls)(n.G,i)),n.fS((()=>(0,s.zG)(o,de.ZQ(e)(t,i(n.YP))))))}var Ce=i(80144);const ye=xe.jA.isKnowledgeHub,Ie=(e,t)=>(0,fe.Kg)(((e,t)=>(0,fe.W9)((0,fe.Kg)(ye,xe.jA.isDocFinished),(i=>i.updateContextInfoId===t&&i.docId===e)))(e,t),(e=>(0,fe.W9)(xe.jA.isUpdateContextInfoFinished,(t=>t.updateContextInfoId===e)))(t));class Se{constructor(e,t=E.Y.create("StaticChecksStateManagerImpl")){this._messages=e,this._logger=t,this._subscriptions=new o.w,this._updateRequests=new le.xQ,this._checks=k.h.create(new Map),this._pendingUpdates=k.h.create(new Map),this._errors=k.h.create(new Map),this.checks=this._checks.view(),this.pendingUpdates=this._pendingUpdates.view(),this.errors=this._errors.view(),this._subscriptions.add(this._updateRequests.pipe(ue.b((({docIds:e,updateContextInfoTask:t})=>l.of(...e.map((e=>({docId:e,updateContextInfoTask:t})))))),he.v((e=>e.docId)),ge.zg(b.w((({docId:e,updateContextInfoTask:t})=>this._handleUpdateContextInfoTask(e,t))))).subscribe())}updateChecksState(e,t){(0,s.zG)(t,ae.fold((t=>this._updateRequests.next({docIds:e,updateContextInfoTask:Promise.resolve(ae.left(t))})),(t=>this._updateRequests.next({docIds:e,updateContextInfoTask:t}))))}dispose(){this._subscriptions.unsubscribe()}_handleUpdateContextInfoTask(e,t){return this._pendingUpdates.modify(de.EG(ne.e.eq)(e)),(0,s.zG)(I.D(t),b.w(ae.fold((t=>(this._logger.warn(`Error getting checks for ${e}`,t),this._errors.modify(ke(e,ce.ri("all"),t)),S.E)),(t=>(this._pendingUpdates.modify(de.ZQ(ne.e.eq)(e,{updateContextInfoId:t,featureChecksCompleted:new Set})),this._handleUpdateContextInfoMessages(e,t))))))}_handleUpdateContextInfoMessages(e,t){return this._messages.pipe(p.h(Ie(e,t)),pe.o((0,s.ff)(xe.jA.isUpdateContextInfoFinished)),me.x((()=>{this._pendingUpdates.modify(de.EG(ne.e.eq)(e)),this._checks.modify((i=>{var n;return(null===(n=i.get(e))||void 0===n?void 0:n.updateContextInfoId)===t?i:(0,s.zG)(i,de.EG(ne.e.eq)(e))}))})),C.b((0,s.ls)(n.DT(xe.jA.isDocFinished),be.bw((({features:t,failed:i})=>this._featuresChecksCompleted(e,t,i))))),p.h(ye),C.b((0,s.ls)(Ee,be.bw(this._insertCheck(e,t)))))}_insertCheck(e,t){return i=>this._checks.modify(we(ne.e.eq)(e,(e=>(0,s.zG)(e,n.g_((()=>({updateContextInfoId:t,checks:[i]})),(e=>({updateContextInfoId:t,checks:[...e.checks,i]})))))))}_featuresChecksCompleted(e,t,i){this._pendingUpdates.modify((i=>(0,s.zG)(i,de.cq(ne.e.eq)(e,(e=>({updateContextInfoId:e.updateContextInfoId,featureChecksCompleted:ce.G0(_e.yv)(t,e.featureChecksCompleted)}))),n.fS((()=>i))))),i&&(this._logger.warn(`CAPI error gettings checks for ${[...t].join(", ")} - ${e}`),this._errors.modify(ke(e,t,new Error(`CAPI failed getting checks for ${e}`))))}}function ke(e,t,i){return we(ne.e.eq)(e,n.g_((()=>new Map([...t].map((e=>[e,[i]])))),(e=>(0,s.zG)([...t],te.u4(e,((e,t)=>(0,s.zG)(e,we(Ce.n.eq)(t,n.g_((()=>te.of(i)),te.QI(i))))))))))}function Ee(e){if(e.kind===xe.jA.Kind.knowledgeHubItem)return n.G({kind:Ce.I.Kind.knowledgeHubItem,id:e.id,span:e.span,docId:e.docId,termId:e.termId,headerText:e.headerText,headerIconSrc:e.headerIconSrc,articleTitle:e.articleTitle,aliases:e.aliases,articleContent:e.articleContent,pointPeople:e.pointPeople,relatedMaterials:e.relatedMaterials,suggestCorrectionUrl:e.suggestCorrectionUrl,grammsUrl:e.grammsUrl});(0,ve.L0)(e.kind)}var Ue,Ne,Ae=i(18117),Ge=i(79965);class ze extends ve.sH{constructor(e){super(e)}}!function(e){e.eq=_e.MW({node:_e.w4,rev:_e.lr})}(Ue||(Ue={})),function(e){e.eqByDocId=_e.Uz((e=>e.id))(ne.e.eq)}(Ne||(Ne={}));var Oe=i(73863),Me=i(97282),Re=i(42530);var Te=i(1933),je=i(96030);class Le{constructor(e,t){this._checkingService=e,this._threadContext=t,this._subscriptions=new o.w,this._optedIn=new se.t(1),this._staticChecksManager=new Se(this._checkingService.messages),this.sessionUuid=this._checkingService.sessionUuid,this.checks=this._staticChecksManager.checks,this.pendingUpdates=this._staticChecksManager.pendingUpdates,this.errors=this._staticChecksManager.errors;this._subscriptions.add(Fe(((e,t)=>this._staticChecksManager.updateChecksState(t,ae.left(e))),this._optedIn,this._threadContext).subscribe((({docIds:e,docInfo:t})=>this._staticChecksManager.updateChecksState(e,ae.right(this._checkingService.updateContextInfo(t))))))}sendKnowledgeHubFeedback(e){this._checkingService.sendKnowledgeHubFeedback(e)}dataOptIn(e){this._optedIn.next(e)}dispose(){this._subscriptions.unsubscribe(),this._staticChecksManager.dispose()}}function Fe(e,t,i){return i.view((e=>new Set(e.messageIndexToIdMap.values()))).pipe((0,Te.Gx)(t.pipe(oe.x())),re.R(((e,t)=>new Set(Array.from(e).concat(Array.from(t)))),new Set),(o=ne.e.eq,(0,s.ls)(f.O(new Set),je.G(),h.U((([e,t])=>ce.e5(o)(e)(t))),p.h((e=>e.size>0)))),function(e,t=0){return i=>{const o=new le.xQ;return(0,s.zG)(i,ue.b((e=>I.D(Array.from(e)))),ge.zg((t=>e.pipe(h.U((e=>(0,s.zG)(n.ij(e.expandedMessages.get(t)),n.g_(s.jv,Ge.d6)))),p.h(Re.fQ),Oe.q(1),m.h(t)))),C.b((()=>o.next())),Me.R((()=>o.pipe(u.b(t)))),h.U((e=>new Set(e))),p.h((e=>e.size>0)))}}(i),h.U((t=>(0,s.zG)([...t],te.UI((t=>(0,s.zG)(function(e,t){return(0,s.zG)(ae.fromNullable(new ze(`message ${e} is not expanded`))(t.expandedMessages.get(e)),ae.chain((t=>Ge.d6(t)?ae.right(t.value):ae.left(new ze(Ge.IR(t)?t.error.message:`message ${e} not extracted`)))),ae.chain((e=>Ae.Yt(ae.either)({containerType:ae.right("email"),docId:ae.right(e.id),title:t.subject,delta:ae.right(e.textMap.getRichText()),siblingIndex:ae.right(e.index),authors:(0,s.zG)(t.loggedUser,ae.map((t=>[{email:e.context.author.email,name:e.context.author.name,currentSessionUser:e.context.author.email===t.email}]))),audience:(0,s.zG)(t.loggedUser,ae.map((t=>e.context.audience.map((e=>({email:e.email,name:e.email,currentSessionUser:e.email===t.email}))))),ae.chain((e=>Ae.Yt(ae.either)({recipients:ae.right(e),channelId:t.threadId,channelName:t.subject})))),metadata:ae.right({email:e.context.metadata})}))))}(t,i.get()),ae.mapLeft((i=>e(i,[t]))),n.Uo))),te.oA,ie.c2,n.UI((e=>({docIds:(0,s.zG)(e,ie.UI((e=>e.docId))),docInfo:{...e[0],siblings:e.slice(1)}})))))),y.oA);var o}var qe=i(22236),De=i(49144),Pe=i(59833),Ve=i(98107),He=i(83780),Ke=i(43636),We=i(61447),$e=i(24184),Be=i(72106),Ye=i(87286),Qe=i(75155),Xe=i(39953),Ze=i(46584);class Je{constructor(e,t){this._rpc=e,this._settings=t,this._token=this._rpc.startSession(this._settings),this.setSessionOption=(...e)=>this._token.then((t=>this._rpc.setSessionOption({token:t,args:e}))),this.ping=(...e)=>this._token.then((t=>this._rpc.ping({token:t,args:e}))),this.close=(...e)=>this._token.then((t=>this._rpc.close({token:t,args:e}))),this.sendFeedback=(...e)=>this._token.then((t=>this._rpc.sendFeedback({token:t,args:e}))),this.getStatus=(...e)=>this._token.then((t=>this._rpc.getStatus({token:t,args:e}))),this.getStatusObs=(...e)=>this._token.then((t=>this._rpc.getStatusObs({token:t,args:e}))),this.getEventsObs=(...e)=>this._token.then((t=>this._rpc.getEventsObs({token:t,args:e}))),this.connect=(...e)=>this._token.then((t=>this._rpc.connect({token:t,args:e}))),this.updateContextInfo=(...e)=>this._token.then((t=>this._rpc.updateContextInfo({token:t,args:e})))}dispose(){this._token.then((e=>this._rpc.stopSession(e)))}}var et=i(91059);class tt{constructor(e,t,i,s,o,r,a,d,c=U.OB,l=E.Y.create("StaticCAPIRpcConnection")){this._domainName=e,this._capiUrl=t,this._supportedFeatures=i,this._clientName=s,this._clientSubType=o,this._clientVersion=r,this._useDlp=a,this._startSessionOptions=d,this._getEnv=c,this._log=l,this._id=et._.createWithRandomId("dn"),this._sessionUuid=null,this._initialSessionUuid=null,this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._subscriptions=[],this._reconnectInfo=n.YP,this._reconnectionStatus=k.h.create(Qe.Td.ready),this._connectionStatus=k.h.create(Qe.QK.waitingForConnection),this.getStatusObs=()=>this._rpc.getStatusObs(),this.reconnect=(e=!0)=>(this.close("Need to reconnect"),e?(this._attemptingReconnect=!0,this._reconnectRequestIncludesReconnectInfo=n.pC(this._reconnectInfo),this._log.debug("[RECONNECT] Reconnecting to existing CAPI session")):(this._attemptingReconnect=!1,this._reconnectRequestIncludesReconnectInfo=!1,this._reconnectInfo=n.YP),this._reconnectionStatus.set(Qe.Td.inProgress),this._initRpcClient(),this._connectionStatus.set(Qe.QK.startingConnection),this._rpc.connect()),this.close=e=>{this._log.trace("Closing connection.",{reason:e}),this._rpc.close(e).catch((t=>{this._log.warn("Can't close api instance",{reason:e,error:t.message?t.message:JSON.stringify(t)})})),this._rpc.dispose(),this._cleanListeners(),this._connectionStatus.set(Qe.QK.waitingForReconnection)},this.getEventsObs=()=>this._rpc.getEventsObs(),this.sendFeedback=async e=>this._reconnectionStatus.get()===Qe.Td.reconnectRequired?(await this.reconnect(),this._rpc.sendFeedback(e)):this._rpc.sendFeedback(e),this.setSessionOption=async e=>this._reconnectionStatus.get()===Qe.Td.reconnectRequired?(await this.reconnect(),this._rpc.setSessionOption(e)):this._rpc.setSessionOption(e),this.updateContextInfo=async e=>this._reconnectionStatus.get()===Qe.Td.reconnectRequired?(await this.reconnect(),this._rpc.updateContextInfo(e)):this._rpc.updateContextInfo(e),this._onSessionStart=({sessionUuid:e,isNewSession:t,reconnectedInfo:i})=>{if(this._sessionUuid=e,t){if(this._log.debug(`[RECONNECT] Initing new session (${e})`),this._id=et._.createWithRandomId("dn"),this._connectionStatus.set(Qe.QK.newSessionStarted),this._attemptingReconnect){const e=(0,Qe.x)(this._reconnectRequestIncludesReconnectInfo,i);(0,Z.Tb)().sendFemetricsRate("reconnectToSessionFailed",{reconnectFailedReason:e}),this._log.debug("[RECONNECT] reconnect failed",e)}this._log.debug(`[RECONNECT] New session (${e})`)}else this._log.debug(`[RECONNECT] Continuing existing session (${e})`),this._connectionStatus.set(Qe.QK.existingSessionStarted),(0,Z.Tb)().sendFemetricsRate("reconnectToSessionSuccess");this._attemptingReconnect=!1,this._initialSessionUuid=this._initialSessionUuid||e,this._reconnectionStatus.set(Qe.Td.ready)},this._initListeners=()=>{this._subscriptions.push(I.D(this.getEventsObs()).pipe($e.B()).subscribe((e=>{Ze.X.is("session_started")(e)?this._onSessionStart(e):Ze.X.is("reconnect_info_updated")(e)&&this._onReconnectInfo(e)})))},this._onReconnectInfo=e=>{this._log.debug("Update reconnect info",e.reconnectInfo),this._reconnectInfo=n.ij(e.reconnectInfo)},this._cleanListeners=()=>{this._subscriptions.forEach((e=>e.unsubscribe())),this._subscriptions=[]},this._initRpcClient=()=>{this._rpc=new Je(this._getEnv().staticCapiBgRpc.api,{domain:this._domainName,capiUrl:this._capiUrl,supportedFeatures:this._supportedFeatures.includes(_.z.reconnect)?this._supportedFeatures:[...this._supportedFeatures,_.z.reconnect],clientName:this._clientName,clientSubType:this._clientSubType,clientVersion:this._clientVersion,startSessionOptions:{...this._startSessionOptions,...(0,Xe.zG)(this._reconnectInfo,n.g_((()=>this._initialSessionUuid?{reconnectInfo:{sessionUuid:this._initialSessionUuid}}:{}),(e=>({reconnectInfo:e}))))},useDlp:this._useDlp}),this._initListeners()},this._listenSWShutdown=()=>{this._getEnv().message.on("bgSW-shutdown",(()=>{this._reconnectionStatus.get()!==Qe.Td.reconnectRequired&&this._connectionStatus.get()!==Qe.QK.waitingForConnection&&(this._log.debug("[RECONNECT] Lost connection to service worker. Queuing up reconnection."),this._reconnectionStatus.set(Qe.Td.reconnectRequired))}))},this._initRpcClient(),this._listenSWShutdown()}get id(){return this._id}get sessionUuid(){return this._sessionUuid}get initialSessionUuid(){return this._initialSessionUuid}get connectionStatus(){return this._connectionStatus}}var it=i(77216);class nt{constructor(e,t=U.OB){this._staticCapiSettings=e,this._getEnv=t,this._subscriptions=[],this._connectionLevelSubscriptions=[],this._sessionUuid=k.h.create(n.YP),this._messages=new le.xQ,this._logger=E.Y.create("StaticCheckingServiceImpl"),this._capi=new tt(this._staticCapiSettings.domain,this._staticCapiSettings.capiUrl,this._staticCapiSettings.supportedFeatures,this._staticCapiSettings.clientName,this._staticCapiSettings.clientSubType,this._staticCapiSettings.clientVersion,this._staticCapiSettings.useDlp,this._staticCapiSettings.startSessionOptions,this._getEnv),this.messages=this._messages.asObservable(),this.sessionUuid=this._sessionUuid.view(),this._initConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.push(I.D(this._capi.getStatusObs()).pipe($e.B()).subscribe((e=>this._logger.info("CAPI API",e)))),this._connectionLevelSubscriptions.push(I.D(this._capi.getEventsObs()).pipe($e.B()).subscribe((e=>{switch(e.kind){case"session_started":this._messages.next({kind:xe.jA.Kind.start,sessionUuid:xe.hX.create(e.sessionUuid),isNewSession:e.isNewSession}),this._sessionUuid.set(n.G(xe.hX.create(e.sessionUuid))),(0,s.zG)(this._sendContainerId(),Be.Vn((e=>this._logger.warn("Could not send containerId to CAPI",e))))();break;case"error":this._messages.next({kind:xe.jA.Kind.error,error:e.error,severity:e.severity});break;case"update_context_info_finished":this._messages.next({kind:xe.jA.Kind.updateContextInfoFinished,updateContextInfoId:e.updateContextInfoId});break;case"doc_finished":this._messages.next({kind:xe.jA.Kind.docFinished,updateContextInfoId:e.updateContextInfoId,docId:e.docId,features:new Set(e.features),failed:e.failed});break;case"reader_doc_info":case"reader_action_item":case"reader_main_point":case"reader_debug":case"reader_summary_item":case"reader_summary_finished":default:break;case"alert_received":{const t=(0,it.IM)(e.alert,et.Q.fromString(e.alert.rev.toString())),i=(0,Ye.VI)(t);this._messages.next({id:xe.jA.KnowledgeHub.ItemId.create(e.alert.id),kind:xe.jA.Kind.knowledgeHubItem,docId:e.alert.docId,updateContextInfoId:e.alert.updateContextInfoId,span:{s:t.highlightRanges[0].start,e:t.highlightRanges[0].end},termId:i.termId,headerText:i.headerText,headerIconSrc:n.ij(i.headerIconSrc),articleContent:i.articleContent,articleTitle:i.articleTitle,aliases:i.aliases,pointPeople:i.pointPeople,relatedMaterials:i.relatedMaterials,suggestCorrectionUrl:i.suggestCorrectionUrl,grammsUrl:i.grammsUrl});break}}})))},this._cleanConnectionLevelListeners=()=>{this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe()))},this._subscriptions.push(this._messages.subscribe((e=>this._logger.debug("Received CAPI message",e)))),this._initConnectionLevelListeners(),this._subscriptions.push(this._capi.connectionStatus.subscribe((e=>this._handleConnectionStatus(e))))}updateContextInfo(e){return this._logger.debug("Received updateContextInfo command",{docId:e.docId}),this._capi.updateContextInfo(e)}sendKnowledgeHubFeedback(e){const t={id:xe.jA.KnowledgeHub.ItemId.toAlertId(e.itemId),kind:st(e.kind)};this._capi.sendFeedback(t)}dispose(e){this._subscriptions.forEach((e=>e.unsubscribe())),this._connectionLevelSubscriptions.forEach((e=>e.unsubscribe())),this._logger.trace("Closing connection.",{reason:e}),this._capi.close(e)}_sendContainerId(){return(0,s.zG)((()=>this._getEnv().bgRpc.api.getContainerIdOrUndefined().then(ae.fromNullable(new Error("Got undefined containerId")))),Be.UI((e=>()=>this._capi.setSessionOption({kind:We.rP.GnarContainerId,id:e}))))}_handleConnectionStatus(e){switch(e){case Qe.QK.startingConnection:this._initConnectionLevelListeners();break;case Qe.QK.waitingForConnection:case Qe.QK.newSessionStarted:case Qe.QK.existingSessionStarted:break;case Qe.QK.waitingForReconnection:this._cleanConnectionLevelListeners();break;default:(0,ve.L0)(e)}}}function st(e){switch(e){case xe.Lu.IGNORE:return We.PZ.IGNORE;case xe.Lu.LOOKED:return We.PZ.LOOKED;default:return(0,ve.L0)(e)}}var ot,rt=i(48822),at=i(49686),dt=i(25583),ct=i(49231),lt=i(14944),ut=i(43818),ht=i(8609),gt=i(72521),pt=i(8902),mt=i(98547),ft=i(46356),bt=i(66241),_t=i(72616),vt=i(80223),xt=i(89225),wt=i(62215),Ct=i(75457);function yt(e,t,i,n=!1,s=!1){const o=(0,q.Me)(e).body,r=(0,q.Jj)(e);let a={left:"0px",top:"0px"};if(t.fieldPaintingPositioning===xt.Q.nonPositioned&&t.positionedAncestor===o){const e=r.getComputedStyle(o);a={left:e.marginLeft||"0px",top:e.marginRight||"0px"}}else if(t.positionedAncestor!==o){const e=r.getComputedStyle(t.positionedAncestor);a={left:e.borderLeftWidth&&`-${e.borderLeftWidth}`||"0px",top:e.borderTopWidth&&`-${e.borderTopWidth}`||"0px"}}return o=>{o.style.position="absolute",o.style.top=a.top,o.style.left=n?"auto":a.left,s||(o.style.right=n?a.left:"auto",o.style.pointerEvents="none"),function({subjectElement:e,isPositioned:t,subjectElementStyle:i,integrationRoot:n,positionedAncestor:s}){t?(n.style.zIndex=i.zIndex,e.insertAdjacentElement("afterend",n)):s.insertAdjacentElement("afterbegin",n)}({subjectElement:e,isPositioned:t.fieldPaintingPositioning===xt.Q.positioned,subjectElementStyle:i,integrationRoot:o,positionedAncestor:t.positionedAncestor})}}function It(e){return gt.Pf.create({...e.client,...e.size})}class St{constructor(e,t=!1,i){this._highlightsSubject=e,this._innerElementsInteractive=t,this._subscriptions=new o.w,this._mouse=k.h.create({offset:null,client:null}),this._fakeMouse=k.h.create(null),this._prepareHighlights=(e,t=(0,q.is)(e))=>{const i=(0,q.o)(e),n=(0,wt.fL)(e,!1,i,t);return{layout:n,rootInjector:yt(e,n,i)}},this._prepareInnerElements=(e,t=(0,q.is)(e),i)=>{const n=(0,q.o)(e),s=i||(0,wt.fL)(e,!1,n,t);return{layout:s,rootInjector:yt(e,s,n,!0,this._innerElementsInteractive)}},this._highlights=this._prepareHighlights(this._highlightsSubject),this._innerElements=this._prepareInnerElements(this._highlightsSubject,void 0,this._highlights.layout),this._win=(0,q.Jj)(this._highlightsSubject),this._createTextNodeRect=e=>({page:j.Cv.fromClient(e.client,{top:this._win.scrollY,left:this._win.scrollX}),offset:e.offset,client:e.client,size:e.size,padding:e.padding}),this.textNode={rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),visibleRect:this._highlights.layout.textField.visibleRect.map(this._createTextNodeRect),scroll:this._highlights.layout.textField.scroll,scrollSize:this._highlights.layout.textField.scrollSize,scroller:(0,L.iX)(this._highlightsSubject,{rect:this._highlights.layout.textField.paddingRect.map(this._createTextNodeRect),scrollSize:this._highlights.layout.textField.scrollSize})},this.highlightHeightOffset=0,this.mouse=k.h.combine(this._mouse,this._fakeMouse,((e,t)=>t||e)),this._subscriptions.add(c.aj([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,h.U)((([e,t])=>({rect:It(e),scroll:t}))),(0,b.w)((({rect:e,scroll:t})=>(0,z.Am)()?(0,mt.q7)(this._win,e,t):(0,mt.B0)(this._win,e,t))),(0,oe.x)(Re.fS)).subscribe(vt.wW(this._mouse))),i&&this._subscriptions.add(c.aj([this._highlights.layout.textField.paddingRect.behavior,this._highlights.layout.textField.scroll.behavior]).pipe((0,h.U)((([e,t])=>({rect:It(e),scroll:t}))),(0,b.w)((({rect:e,scroll:t})=>i.pipe(h.U((i=>{if(i){const n=j.Ir.create({left:i.clientX,top:i.clientY});return{client:n,offset:gt.UL.contains(n,e)?j.p8.fromClientPoint(n,e,t):null}}return null}))))),(0,oe.x)(Re.fS)).subscribe(vt.wW(this._fakeMouse)))}createGeometryLayout(){return new pt.D((()=>It(this._highlights.layout.textField.paddingRect.getCurrent())),(()=>this._highlights.layout.textField.scroll.getCurrent()),(()=>It(this._highlights.layout.textField.paddingRect.getApproximate())),(()=>this._highlights.layout.textField.scroll.getApproximate()))}render(e,t){var i;const n=(0,q.Me)(this._highlightsSubject),s=null!==(i=t.highlightsLayoutMargin)&&void 0!==i?i:0,o=e.highlights&&ft.V.get({monitorAs:"highlights"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),(e=>{this._highlights.rootInjector(e)}),_t.G7.showWhenLoaded(ct.createElement("div",{"data-grammarly-part":"highlights",style:{position:"absolute",top:0,left:0}},ct.createElement(Ct.V,{layout:this._highlights.layout,margin:s},ct.createElement(ut.F.div,{style:this.textNode.scrollSize.behavior.pipe(h.U((e=>({position:"absolute",height:e.height,width:e.width,top:s,left:s}))))},ct.createElement(e.highlights,null)))))),r=e.innerElements&&ft.V.get({monitorAs:"inner-elements"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),this._innerElements.rootInjector,_t.G7.showWhenLoaded(ct.createElement("div",{"data-grammarly-part":"inner-elements",style:{position:"absolute",top:0,right:0}},ct.createElement(ht.Lm,null),ct.createElement(e.innerElements,null)))),a=e.outerElements&&ft.V.get({monitorAs:"outer-elements"}).inject(bt.EM.fromDocument(n,"grammarly-extension"),bt.zs.appendChild(n.documentElement),_t.G7.showWhenLoaded(ct.createElement(e.outerElements,null)),{eventPropagationHandler:t.eventPropagationHandler});return{dispose:()=>{null==o||o.dispose(),null==a||a.dispose(),null==r||r.dispose()}}}dispose(){this._subscriptions.unsubscribe()}}!function(e){e.ord=lt.Uz((e=>e.order))(lt.Mh)}(ot||(ot={}));class kt{constructor(e,t,i,n){this._docId=e,this._docNode=t,this._textMap=i,this._mouseOverride=n,this._views=new Map,this._rootView=null}addAnnotationsViewFactories(e){this._rootView=this._rootView||this._createRootView();for(const[t,i]of e){const e=i(this._docId,this._docNode,this._textMap,this._rootView.layout);this._views.set(t,e),this._rootView.cards.modify((i=>i.concat({id:t,view:e.cardsUI}))),this._rootView.highlights.modify((i=>i.concat({id:t,view:e.highlightsUI,order:e.highlightsLayerOrder})))}}removeAnnotationsView(e){var t;this._rootView&&(this._rootView.cards.modify(te.hX((t=>t.id!==e))),this._rootView.highlights.modify(te.hX((t=>t.id!==e)))),null===(t=this._views.get(e))||void 0===t||t.dispose(),this._views.delete(e),0===this._views.size&&this._clearRootView()}dispose(){this._views.forEach((e=>e.dispose())),this._clearRootView()}_clearRootView(){this._rootView&&(this._rootView.renderResult.dispose(),this._rootView.layout.dispose(),this._rootView=null)}_createRootView(){var e;const t=new St(this._docNode,!0,null===(e=this._mouseOverride)||void 0===e?void 0:e.pipe(h.U(n.WG))),i=k.h.create([]),o=k.h.create([]);return{cards:i,highlights:o,layout:t,renderResult:t.render({highlights:()=>ct.createElement(ut.F.Fragment,null,o.view((0,s.ls)(te.DY(ot.ord),te.UI((({id:e,view:t})=>ct.createElement(t,{key:e})))))),outerElements:()=>ct.createElement(ut.F.Fragment,null,i.view(te.UI((({id:e,view:t})=>ct.createElement(t,{key:e})))))},{highlightsLayoutMargin:0})}}}var Et,Ut=i(35312),Nt=i(16925),At=i(22639),Gt=i(4582),zt=i(91486),Ot=i(69773);class Mt{constructor(e=!0){this._collateLines=e}create(e,t){return{getRects:()=>{var i;const n=[];let o,r=e.start,a=!1;do{const s=t.getFragmentAtOrBeforeOffset(r);if(s&&o!==r){o=r;if(null===(i=s.node.textContent)||void 0===i?void 0:i.replace(/\s/g,"")){const i=Ot.M.createRange(t,r,Math.min(s.endOffset,e.end));i&&n.push(...Array.from(i.getClientRects()))}r=s.endOffset===r?s.endOffset+1:s.endOffset}else a=!0}while(r<e.end&&!a);return(0,Xe.zG)(n,zt.es,this._collateLines?zt.yX:s.yR,Pe.UI(gt.Pf.create))}}}getClientRects(e){return e.getRects()}getIsInvalid(e){return!1}getIsConsistent(e,t,i){return!0}dispose(e){}}function Rt(e,t,i,o,r,a,d){const c=new Mt(!1),l=new At.C(c,o.createGeometryLayout(),(()=>a),(0,Nt.u)(),(0,Gt.WF)(o.textNode)),u=new Map,g=t.pipe(function(e){return(0,s.ls)(h.U(de.P5(ne.e.eq)(e)),f.O(n.YP),je.G(),h.U((([e,t])=>(0,s.zG)(t,n.UI((t=>{const{removed:i,added:o}=function(e,t){const{left:i,right:n}=(0,s.zG)(at.yi(Ut.q.eq)(new Map(e.map((e=>[e.id,e]))),new Map(t.map((e=>[e.id,e])))),dt.v.reduce({left:[],right:[]},((e,t)=>({...e,left:e.left.concat(t)})),((e,t,i)=>({left:e.left.concat(t),right:e.right.concat(i)})),((e,t)=>({...e,right:e.right.concat(t)}))));return{removed:i,added:n}}((0,s.zG)(e,n.fS((()=>[]))),t);return{kind:"update",annotations:t,removed:i,added:o}})),n.Gk((()=>(0,s.zG)(e,n.UI((e=>({kind:"allRemoved",removed:e}))))))))),y.oA)}(e)).subscribe((t=>{if("allRemoved"===t.kind)l.removeHighlights(Array.from(u.values())),u.clear(),d.trace(`Annotations for ${e} cleared`);else if("update"===t.kind){const e=(0,s.zG)(t.removed,te.UI((e=>e.id)),te.u4([],((e,t)=>(0,s.zG)(u,de.P5(Ut.q.Id.eq)(t),n.g_((()=>e),(i=>(u.delete(t),e.concat(i))))))));e.length>0&&(l.removeHighlights(e),d.trace("Removed annotation highlights",e));const i=t.added.map((e=>{const t=Gt.y$.Id.create(e.id);return u.set(e.id,t),l.addHighlight(t,{start:e.span.s,end:e.span.e},{highlightId:t,annotation:e,highlightColor:null,highlightDisplayFormat:null,highlightLiveliness:null,alertId:""}),t}));i.length>0&&d.trace("Added annotation highlight",i)}else(0,ve.L0)(t)})),p=i({docId:e,docNode:r,docLayout:o,highlightsCollection:l});return{highlightsLayerOrder:p.highlightsLayerOrder,highlightsUI:p.highlightsUI,cardsUI:p.cardsUI,dispose:()=>{p.dispose(),g.unsubscribe(),l.dispose(),d.trace("Annotations view disposed")}}}!function(e){e.eq=_e.Uz((e=>({docId:e.docId,textNode:e.textNode})))(_e.MW({docId:ne.e.eq,textNode:Ue.eq}))}(Et||(Et={}));class Tt{constructor(e,t,i=E.Y.create("gmail.annotationsManager")){this._messagesRoot=t,this._logger=i,this._subscriptions=new rt.L,this._nodesAndIntegrations=new Map,this._annotationsViewsFactories=new Map,this._textNodeToDocId=new WeakMap,this._hiddenDocs=new WeakMap,this._nodeChangesOverride=new le.xQ,this._intersectionObserver=this._initIntersectionObserver(),this._mouseOverride=new De.X(n.YP),this._subscriptions.add(a.T(e.pipe((0,s.ls)(f.O(new Map),je.G(),h.U((([e,t])=>(0,s.zG)(at.yi(Et.eq)(e,t),dt.v.reduce([],((e,{docId:t})=>e.concat({kind:"remove",docId:t})),((e,t,i)=>Ue.eq.equals(t.textNode,i.textNode)?e:e.concat({kind:"remove",docId:t.docId},{kind:"add",...i})),((e,t)=>e.concat({kind:"add",...t})))))),ge.zg(s.yR))),this._nodeChangesOverride).subscribe((e=>{if("remove"===e.kind)(0,s.zG)(n.ij(this._nodesAndIntegrations.get(e.docId)),be.bw((e=>{e.integration.dispose(),this._textNodeToDocId.delete(e.textNode.node),this._intersectionObserver.unobserve(e.textNode.node)}))),this._nodesAndIntegrations.delete(e.docId),this._logger.trace(`Annotation integrations for ${e.docId} cleared`);else if("add"===e.kind){const t=new kt(e.docId,e.textNode.node,e.textMap,this._mouseOverride);t.addAnnotationsViewFactories(this._annotationsViewsFactories),this._nodesAndIntegrations.set(e.docId,{docId:e.docId,textMap:e.textMap,textNode:e.textNode,integration:t}),this._textNodeToDocId.set(e.textNode.node,e.docId),this._intersectionObserver.observe(e.textNode.node)}else(0,ve.L0)(e)})))}createIntegration(e){const t=Re.iy.create(),i=(t,i,n,s)=>Rt(t,e.annotations,e.createAnnotationsView,s,i,n,this._logger);this._annotationsViewsFactories.set(t,i),this._nodesAndIntegrations.forEach((({integration:e})=>e.addAnnotationsViewFactories(new Map([[t,i]]))));const n=(e.mouseOverride||S.E).subscribe((e=>{this._mouseOverride.next(e)}));return{dispose:()=>{n.unsubscribe(),this._nodesAndIntegrations.forEach((({integration:e})=>e.removeAnnotationsView(t))),this._annotationsViewsFactories.delete(t)}}}_initIntersectionObserver(){return new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?(0,s.zG)(n.ij(this._hiddenDocs.get(e.target)),be.bw((t=>{this._logger.debug(`Message ${t.docId} visible, restoring annotation integrations`),this._hiddenDocs.delete(e.target),this._nodeChangesOverride.next({kind:"add",...t})}))):(0,s.zG)(n.ij(this._textNodeToDocId.get(e.target)),n.tS((e=>n.ij(this._nodesAndIntegrations.get(e)))),be.bw((({docId:t,textNode:i,textMap:n})=>{this._logger.debug(`Message ${t} hidden, clearing annotation integrations`),this._nodeChangesOverride.next({kind:"remove",docId:t}),this._hiddenDocs.set(e.target,{docId:t,textNode:i,textMap:n}),this._intersectionObserver.observe(i.node)})))}))}),{root:this._messagesRoot})}dispose(){this._subscriptions.unsubscribe(),this._intersectionObserver.disconnect(),this._nodesAndIntegrations.forEach((({integration:e})=>e.dispose())),this._nodesAndIntegrations.clear(),this._annotationsViewsFactories.clear()}}var jt=i(88686),Lt=i(17888),Ft=i(86185);const qt='[role="main"] [data-thread-perm-id]',Dt='[role="main"] [role="list"]',Pt="data-message-id",Vt='[data-message-id] [jslog] > div[id^=":"]',Ht='span[title][role="gridcell"]',Kt='span[role="gridcell"] span[email][name]',Wt='span:not([role="gridcell"]) span[email][name]',$t="lang",Bt="html[lang]",Yt=`${Vt} a[href]`,Qt="h3 span[idlink][role=link]";var Xt,Zt,Jt;!function(e){e.empty=function(){return{messages:new Map,added:new Set,updated:new Set,removed:new Set}}}(Xt||(Xt={})),function(e){e.isExpanded=function(e){return n.pC(e.bodyNode)&&n.pC(e.id)}}(Zt||(Zt={})),function(e){e.eqByBodyNodeAndRev=_e.Uz(Ke.ei("bodyNode"))(n.Eh(Ue.eq))}(Jt||(Jt={}));class ei{constructor(e,t=E.Y.create("gmail.expandedMessages")){var i;this._messageList=e,this._logger=t,this._messageCount=k.h.create(ii(this._messageList).length),this.messageCount=this._messageCount.view(),this.expandedMessages=(i=this._messageList,new r.y((e=>{const t=new o.w,a=new Map,d=new De.X(new Map),c=new le.xQ,u=new IntersectionObserver((e=>e.forEach((e=>{e.isIntersecting||c.next(e.target)}))),{root:null});return t.add(Q.x.create(i,{childList:!0}).pipe(h.U((e=>({added:e.flatMap((e=>Array.from(e.addedNodes))).filter(ni),removed:e.flatMap((e=>Array.from(e.removedNodes))).filter(ni)}))),f.O({added:ii(i),removed:new Array})).subscribe((({added:e,removed:t})=>{t.forEach((e=>{var t;null===(t=a.get(e))||void 0===t||t.unsubscribe(),d.next((0,s.zG)(de.EG(_e.w4)(e)(d.value),ti(i)))})),e.forEach((e=>{var t;null===(t=a.get(e))||void 0===t||t.unsubscribe();const g=function(e,t,i){return new r.y((r=>{const a=new o.w,d=new De.X({bodyNode:(0,s.zG)(si(i),n.UI((e=>({node:e,rev:0})))),id:oi(i)});return n.Wi(d.value.bodyNode)&&a.add(Q.x.create(i,{attributes:!0,attributeFilter:["aria-expanded","tabindex"]}).pipe(h.U((()=>si(i))),y.oA,Oe.q(1)).subscribe((e=>d.next({bodyNode:n.G({node:e,rev:0}),id:(0,s.zG)(d.value.id,n.wp((()=>oi(i))))})))),a.add(d.subscribe((({bodyNode:t,id:i})=>{(0,s.zG)(t,be.bw((t=>{e.observe(t.node)}))),r.next({bodyNode:t,id:i})}))),a.add(t.pipe(p.h((e=>(0,s.zG)(d.value.bodyNode,n.UI((e=>e.node)),be.FX(e))&&!document.contains(e)))).subscribe((t=>{e.unobserve(t),d.next({bodyNode:(0,s.zG)(si(i),n.UI((e=>({node:e,rev:0})))),id:d.value.id})}))),()=>{a.unsubscribe()}})).pipe(b.w((({bodyNode:e,id:t})=>(0,s.zG)(e,n.g_((()=>l.of({bodyNode:n.YP,id:t})),(e=>Q.x.create(e.node,{subtree:!0,childList:!0,attributes:!1,characterData:!0}).pipe(re.R((e=>e+1),e.rev),f.O(0),h.U((i=>({bodyNode:n.G({node:e.node,rev:i}),id:t}))))))))))}(u,c,e).pipe(f.O({bodyNode:n.YP,id:n.YP}),je.G()).subscribe((([{bodyNode:t},{bodyNode:o,id:r}])=>{n.pC(t)&&n.Wi(o)?d.next((0,s.zG)(de.EG(_e.w4)(e)(d.value),ti(i))):d.next((0,s.zG)(d.value,de.cq(_e.w4)(e,(e=>({...e,bodyNode:o,id:r}))),n.fS((()=>de.ZQ(_e.w4)(e,{messageNode:e,bodyNode:o,id:r,index:d.value.size})(d.value)))))}));a.set(e,g)}))}))),t.add(d.subscribe((t=>e.next(t)))),()=>{t.unsubscribe();for(const e of a.values())e.unsubscribe();u.disconnect()}}))).pipe(C.b((e=>this._messageCount.set(e.size))),jt.e(50),C.b((e=>this._logger.debug("message nodes map updated",e))),h.U(de.hX(Zt.isExpanded)),Lt.shareReplay({bufferSize:1,refCount:!0}),f.O(de.cS),je.G(),h.U((([e,t])=>function(e,t){return(0,s.zG)(at.yi(Jt.eqByBodyNodeAndRev)(e,t),dt.v.reduce({messages:new Map(Array.from(t.values()).map((e=>[e.id.value,{...e,id:e.id.value,bodyNode:e.bodyNode.value}]))),added:new Set,updated:new Set,removed:new Set},((e,t)=>({...e,removed:e.removed.add(t.id.value)})),((e,t,i)=>({...e,updated:e.updated.add(i.id.value)})),((e,t)=>({...e,added:e.added.add(t.id.value)}))))}(e,t))))}}function ti(e){const t=new Map(ii(e).map(((e,t)=>[e,t])));return e=>(0,s.zG)(e,de.Su(((e,i)=>(0,s.zG)(n.ij(t.get(e)),n.g_((()=>i),(e=>({...i,index:e})))))))}function ii(e){return Array.from(e.children).filter(ni)}function ni(e){return e instanceof HTMLDivElement&&(e.matches("[aria-expanded]")&&!!e.innerText||!e.matches("[aria-expanded]"))}function si(e){return(0,U.OB)().experimentClient.isGateEnabled(X.K.FixGmailHouseCat)?(0,s.zG)(n.ij(document.contains(e)?e.querySelector(Vt):null),n.hX(Ft.Re)):(0,s.zG)(n.ij(e.querySelector(Vt)),n.hX(Ft.Re))}function oi(e){var t,i;return n.ij(null===(i=null===(t=e.querySelector("[data-message-id]"))||void 0===t?void 0:t.getAttribute(Pt))||void 0===i?void 0:i.slice(1))}var ri=i(46112);var ai,di,ci,li=i(35854),ui=i(67223),hi=i(70163),gi=i(64218),pi=i(78008),mi=i(11633),fi=i(97882);!function(e){e.codec=mi.UQ(mi.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkMIMEType"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),n.Uo):n.YP}}(ai||(ai={})),function(e){e.codec=mi.UQ(mi.Z_,(e=>"string"==typeof e&&e.trim().length>0),"LinkURL"),e.create=function(t){return t?(0,s.zG)(e.codec.decode(t),n.Uo):n.YP},e.eq=_e.yv}(di||(di={})),function(e){e.hyperlink="hyperlink",e.email="email",e.attachment="attachment"}(ci||(ci={}));const bi=mi.OT(mi.dt({name:mi.Z_,url:di.codec,type:fi.Dy.createStringEnum(ci,"mailLinkType")})),_i=mi.jV([bi,mi.OT(mi.dt({type:mi.i0(ci.email)}))]),vi=mi.jV([bi,mi.OT(mi.dt({type:mi.i0(ci.hyperlink)}))]),xi=mi.jV([bi,mi.OT(mi.dt({type:mi.i0(ci.attachment)})),mi.OT(mi.r$({mimeType:ai.codec}))]);var wi;!function(e){e.isAttachment=e=>e.type===ci.attachment,e.codec=mi.G0([_i,vi,xi])}(wi||(wi={}));var Ci=i(12532);function yi(e){const t=[];e.querySelectorAll("table").forEach((e=>{0!==t.length&&t[t.length-1].contains(e)||t.push(e)}));const i=e.innerText.replace(/\s+/g,""),n=t.map((e=>e.innerText.replace(/\s+/g,"")));let s=i;for(const e of n)s=s.replace(e,"");const o=Math.max(0,Math.min(1,(i.length-s.length)/i.length));return Number.isNaN(o)?void 0:o}function Ii(e,t,i){return n=>new r.y((o=>{const r=n.pipe(ui.u(),h.U((e=>({message:e}))),hi.B()).pipe(he.v((e=>e.message.id)),ge.zg((i=>i.pipe(b.w((i=>function(e,t,i){var n;const o=(0,s.zG)(ae.fromNullable(new ze("No message date found"))(null===(n=t.messageNode.querySelector(Ht))||void 0===n?void 0:n.getAttribute("title")),ae.map((t=>(0,s.zG)(new Date(t),(i=>{var n;return Number.isNaN(i.valueOf())?{kind:"unparsedDate",date:t,locale:(null===(n=e.querySelector(Bt))||void 0===n?void 0:n.getAttribute($t))||void 0}:{kind:"parsedDate",timestamp:i.getTime()}}))))),r=(0,s.zG)(ae.fromNullable(new ze("No message author found"))(t.messageNode.querySelector(Kt)),ae.chain(Si)),a=(0,s.zG)(ae.fromNullable(new ze("No <to> field found in message"))(t.messageNode.querySelectorAll(Wt)),ae.chain((e=>(0,s.zG)(Array.from(e),Pe.UI(Si),Pe.IX.sequence(ae.either),ae.chain((0,s.ls)(ie.nI,ae.fromOption((()=>new ze("No audience found"))))))))),d=(0,s.zG)(t.messageNode.querySelector(Qt),(e=>ae.right(!!e)));return c.aj([l.of({date:o,author:r,audience:a,hasListUnsubscribeLink:d}),i(t.messageNode)]).pipe(h.U((([{date:e,author:i,audience:n,hasListUnsubscribeLink:s},o])=>Ae.Yt(ae.either)({date:e,author:i,audience:n,links:ae.right(o),hasListUnsubscribeLink:s,tableTextCoverage:ae.right(yi(t.bodyNode.node))}))))}(e,i.message,t).pipe(h.U((e=>({...i,messageId:i.message.id,domContext:e}))),function(e,t=6e3){return i=>i.pipe((0,Te.Vh)(t),gi.K((t=>l.of(e(t)))))}((e=>({...i,messageId:i.message.id,domContext:ae.left(new ze("DOM extraction timeout"+((0,Ci.H)(e)?` [${e.message}]`:"")))}))),h.U((e=>({...e,type:"fromDOM"}))))))))),C.b((e=>(0,s.zG)(e.domContext,ae.fold((t=>i.warn(`DOM context extraction error for ${e.messageId}`,t)),(t=>i.trace(`DOM context extracted for ${e.messageId}`,t)))))),hi.B()),a=r.pipe(h.U((e=>({message:e.message,context:(0,s.zG)(e.domContext,ae.map((e=>({author:e.author,audience:e.audience,date:e.date,links:e.links,metadata:{tableTextCoverage:e.tableTextCoverage,listUnsubscribe:e.hasListUnsubscribeLink?["has-unsubscribe-link"]:void 0,replyTo:void 0,contentType:void 0}}))))}))),C.b((e=>(0,s.zG)(e.context,ae.fold((t=>i.warn(`Context extraction error for ${e.message.id}`,t)),(t=>i.info(`Context extracted for ${e.message.id}`,t))))))).subscribe((e=>o.next(e)));return()=>a.unsubscribe()}))}function Si(e){return Ae.Yt(ae.either)({email:(0,s.zG)(ae.fromNullable(new ze("No email found"))(null==e?void 0:e.getAttribute("email")),ae.chain((e=>ae.fromOption((()=>new ze("Invalid email address")))(li.G.create(e))))),name:(0,s.zG)(ae.fromNullable(new ze("No name found"))(null==e?void 0:e.getAttribute("name")),ae.map((e=>e||void 0)))})}function ki(e){return(0,s.zG)(Array.from(e.querySelectorAll(Yt)),Pe.DZ((0,s.ls)(n.DT((e=>!e.closest(".gmail_quote")&&!e.matches("a.gmail_plusreply"))),n.tS((e=>(0,s.zG)(di.create(e.getAttribute("href")),n.UI((t=>({url:t,name:(0,s.zG)(n.ij(e.getAttribute("aria-label")),n.fS((()=>e.innerText.trim()))),type:t.startsWith("mailto:")?ci.email:ci.hyperlink})))))))))}function Ei(e){return(0,s.zG)(n.ij(e),n.tS((e=>n.ij(/^([^:]+):([^:]+):(https?:\/\/.+)?(https?:\/\/.+)$/.exec(e)))),n.tS((([e,t,i,o,r])=>(0,s.zG)(di.create(r),n.UI((e=>({name:decodeURIComponent(i),url:e,type:ci.attachment,mimeType:n.FS(ai.create(t))})))))))}function Ui(e){return(0,s.zG)(di.create(e.getAttribute("href")),n.UI((t=>{var i;return{name:e.getAttribute("data-tooltip")||(null===(i=e.querySelector("div"))||void 0===i?void 0:i.innerText)||e.innerText,url:t,type:ci.attachment,mimeType:void 0}})))}function Ni(e){return c.aj([l.of(ki(e)),(0,s.zG)(Array.from(e.querySelectorAll("a[role=link]")).map((e=>function(e,t=4e3){return(0,s.zG)(e.getAttribute("href")||"",n.DT((e=>!/^https?:\/\/docs\.google\.[^./]+\//.test(e))),n.UI((i=>new r.y((t=>{var i;(0,s.zG)(n.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),n.hX((e=>!!e)),n.g_((()=>t.error("Attachment not found")),(()=>{t.next(!0),t.complete()})))})).pipe((0,Te.WV)(t/200,200),pi.V(t),gi.K((()=>l.of(!1))),h.U((t=>{var i;return(0,s.zG)(n.ij(null===(i=e.parentElement)||void 0===i?void 0:i.getAttribute("download_url")),n.tS(Ei),n.wp((()=>Ui(e))))}))))),n.fS((()=>l.of(Ui(e)))),y.oA)}(e))),(e=>e.length>0?c.aj(e):l.of([])))]).pipe(h.U((([e,t])=>Array.from(e.concat(t).reduce(((e,t)=>e.set(t.url,t)),new Map).values()))))}var Ai=i(30181),Gi=i(81685),zi=i(70989),Oi=i(47338),Mi=i(18615),Ri=i(21768),Ti=i(48689),ji=i(19775),Li=i(68860);var Fi,qi,Di=i(11338);!function(e){function t(e){const t=e.ownerDocument&&e.ownerDocument.defaultView&&e.ownerDocument.defaultView.getComputedStyle(e);return!!t&&("auto"===t.overflow||"scroll"===t.overflow||"auto"===t.overflowY||"scroll"===t.overflowY||"auto"===t.overflowX||"scroll"===t.overflowX)}function i(e){const i=e.closest('div[style*="max-height"]'),n=i&&i.querySelector('div > div[style*="display:none"]');return i&&t(i)&&n?i:(0,Li.dk)(e,50).find((e=>t(e)))||null}e.getComposeFieldContainer=i,e.hasOverlayAncestor=function(e){const t=e.closest("body > div");if(!t)return!1;const i=e.ownerDocument&&e.ownerDocument.defaultView&&e.ownerDocument.defaultView.getComputedStyle(t);return!!i&&"absolute"===i.position&&0===parseInt(i.top||"",10)&&0===parseInt(i.left||"",10)},e.getFormattingToolbarContainer=function(e){const t=e&&e.querySelector('div[aria-label="Formatting options"], div[role="toolbar"]');return t&&(t.closest('[style*="visibility"]')||t.closest('[style*="display"]'))},e.getSendButton=function(e){const t=e&&e.closest("table"),i=t&&t.querySelector("table[role=group] [aria-haspopup=true]");return i&&i.parentElement},e.getMinimizableComposeContainer=function(e){const t=e.closest('div[role="region"][aria-label]');return t&&t.parentElement&&t.parentElement.parentElement&&t.parentElement.parentElement.parentElement},e.getSubmitObservable=function(t,i){const n=e.getComposeFieldContainer(t),s=n?e.getSendButton(n):null,o=(0,Ti.O)().config.systemInfo.os.isMac,r=(0,d.R)(t,"keydown").pipe((0,p.h)((e=>13===e.keyCode&&e[o?"metaKey":"ctrlKey"]))),c=s?(0,d.R)(s,"click"):null;return(c?(0,a.T)(r,c):r).pipe((0,zi.M)(null!=i?i:(0,l.of)(null)),(0,Oi.n)((([e,t])=>{var i,n,s;return(null!==(s=null===(n=null===(i=null==t?void 0:t.docContextInfo.audience)||void 0===i?void 0:i.recipients)||void 0===n?void 0:n.length)&&void 0!==s?s:0)<1})),(0,hi.B)(),(0,Oe.q)(1))};class o{constructor(){this._suggestionsSelectors=["[data-suggestion-text]"],this._underlinesSelectors=['[aria-invalid="spelling"]','[aria-invalid="grammar"]'],this._hideCallsCount=0}_getNativeSuggestionParent(){var e,t;const i=document.querySelector(this._suggestionsSelectors.join(",")),n=null===(t=null===(e=null==i?void 0:i.parentElement)||void 0===e?void 0:e.parentElement)||void 0===t?void 0:t.parentElement;return n instanceof HTMLElement&&"absolute"===n.style.position?n:null}_addStyles(e){this._styleEl=document.createElement("STYLE"),this._styleEl.innerHTML=(e?`.${e}{display: none !important}`:"")+this._underlinesSelectors.map((e=>`${e}{background: none !important}`)).join(""),document.head.appendChild(this._styleEl)}_removeStyles(){this._styleEl&&(this._styleEl.remove(),this._styleEl=null)}_cleanupSubscription(){this._popupContainerWaiter&&(this._popupContainerWaiter.unsubscribe(),this._popupContainerWaiter=null)}hide(){if(this._hideCallsCount++,1===this._hideCallsCount){const e=this._getNativeSuggestionParent();e?this._addStyles(e.className):(this._popupContainerWaiter=Q.x.observeChildList(document.body).pipe((0,h.U)((e=>this._getNativeSuggestionParent())),(0,Mi.P)((e=>!!e)),(0,Oe.q)(1),(0,h.U)((e=>{this._removeStyles(),this._cleanupSubscription(),this._addStyles(e.className)}))).subscribe(),this._addStyles(null))}}show(){if(this._hideCallsCount--,0===this._hideCallsCount){this._cleanupSubscription(),this._removeStyles();const e=this._getNativeSuggestionParent();if(e){const t=e.querySelector(this._suggestionsSelectors.join(","));if(t&&t instanceof HTMLElement){const i=t.style.height;t.style.height="auto";const n=t.clientHeight,s=t.clientWidth;e.style.height=`${n}px`,e.style.width=`${s}px`,t.style.height=i}}}this._hideCallsCount<0&&(this._hideCallsCount=0)}}let r;function u(e,t,i){return e?ji.S.sec1.pipe((0,f.O)(null),(0,h.U)(t),(0,Mi.P)((e=>!!e)),(0,Oe.q)(1),(0,b.w)(i),(0,f.O)(null)):(0,l.of)(null)}e.hideNativeSuggestions=function(){r||(r=new o),r.hide()},e.showNativeSuggestions=function(){r&&r.show()},e.isCompose=function(t){const i=t.closest('[style*="float"]');return!!i&&(!(!t.ownerDocument||!t.ownerDocument.defaultView)&&"right"===t.ownerDocument.defaultView.getComputedStyle(i).cssFloat&&e.hasOverlayAncestor(t))},e.isFullscreenCompose=function(t){return e.hasOverlayAncestor(t)&&!e.isCompose(t)},e.isStandaloneCompose=function(e){return 0===e.ownerDocument.querySelectorAll('[role*="navigation"], [role*="complimentary"], [aria-label*="Hangouts"]').length},e.isComposeReply=function(e){const t=e.closest("[role=list]");return!!t&&!!t.querySelector("[data-message-id]")},e.isInConfidentialMode=function(e){const t=(i(e)||e).closest("table");return!!(null==t?void 0:t.querySelector('[aria-label="Turn off confidential mode"]'))};const m=e=>e?Q.x.observeStyle(e).pipe((0,f.O)(e.style),(0,h.U)((e=>"collapse"!==e.visibility&&"hidden"!==e.visibility&&"none"!==e.display)),(0,oe.x)(Re.fS),(0,h.U)((t=>({visible:t,el:e})))):(0,l.of)(null);e.createToolbarVisibleObservable=function(t){return u(t,(i=>t&&e.getFormattingToolbarContainer(t)),m)},e.createMinimizableComposeContainerVisibilityObservable=function(t){return u(t,(i=>t&&e.getMinimizableComposeContainer(t)),m)};const _="input[name=attach][type=hidden]",v="div[aria-label^='Uploading attachment:']";e.createAttachmentsListObservable=function(e){return u(e,(t=>{if(e){const t=(0,Li.Yq)(e,1);return t?t.querySelector(_)||t.querySelector(v):null}return null}),(e=>{const t=(0,Li.Yq)(e,3);return t?Q.x.observeChildList(t).pipe((0,f.O)(t.childNodes),(0,h.U)((e=>Array.from(e).filter((e=>!!(0,Ft.Tv)(e)&&(!!e.querySelector(_)||!!e.querySelector(v)))).map((e=>e))))):(0,l.of)(null)}))},e.attachmentsMetricsObservable=(e,t,i)=>(0,c.aj)(e,t,i,((e,t,i)=>{{const t={top:0,width:0};if(e&&e.length){const i=e[0].firstElementChild;if(i&&(0,Ft.Tv)(i)&&"DIV"===i.nodeName){const e=i,n=e.offsetTop;if(n)return{top:n,width:e.offsetWidth};{const i=e.offsetParent;return i&&"DIV"===i.nodeName?{top:i.offsetTop,width:e.offsetWidth}:t}}return t}return t}}));const x=[{recipientNodeSelector:"[data-name]",authorNodeSelector:'header [role="button"] a[aria-label]',authorIndex:"first",recipientFromNode:(e,t)=>e.matches(t)?{name:e.getAttribute("data-name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0}:null},{recipientNodeSelector:"input[name=to]",authorNodeSelector:'header a[role="button"][aria-label]',authorIndex:"last",recipientFromNode:(e,t)=>e.matches(t)?function(e){const t=/^[\"\']?([^\<\>\"\']+)[\"\']? \<(.+)\>/.exec(e);return t?{name:t[1],email:t[2]}:{email:e}}(e.value||""):null}];function w(e,t){return e.map((e=>x.reduce(((t,i)=>{if(t)return t;const n=i.recipientFromNode(e,i.recipientNodeSelector);return n?{...n,kind:S(e)}:null}),null))).filter((e=>Boolean(e&&(e.name||e.email)))).reduce(((e,t)=>(e.find((e=>e.email===t.email&&e.name===t.name))||e.push(t),e)),[]).map((e=>({...e,currentSessionUser:Boolean(t&&e.email===t.email)})))}function C(e,t){return(0,s.zG)(n.ij(document.querySelector(`[data-message-id="${e}"]`)),n.UI((e=>Array.from(e.querySelectorAll("[name][email][data-hovercard-id]")).slice(1))),n.UI((e=>e.map((e=>({name:e.getAttribute("name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0,kind:"direct"}))).filter((e=>Boolean(e.name||e.email))).reduce(((e,t)=>(e.find((e=>e.email===t.email&&e.name===t.name))||e.push(t),e)),t?[t]:[]))),n.g_((()=>[]),s.yR))}function y(e,t){return(0,s.zG)(n.ij(document.querySelector(`[data-message-id="${e}"]`)),n.tS((e=>n.ij(e.querySelector("[name][email][data-hovercard-id]")))),n.UI((e=>({name:e.getAttribute("name")||void 0,email:e.getAttribute("data-hovercard-id")||void 0}))),n.hX((e=>Boolean(e.name||e.email))),n.UI((e=>({...e,currentSessionUser:Boolean(t&&e.email===t.email)}))),n.WG)}function I(e){const t=(e=>`[data-message-id="${e}"] [jslog] > div[id^=":"]`)(e);return(0,s.zG)(n.ij(document.querySelector(t)),n.hX(Ft.Re),n.UI(Vi),n.UI((e=>e.getRichText())),n.g_((()=>(new Ri.i).insert("")),s.yR))}function S(e){return e.closest("[name=to]")?"direct":e.closest("[name=cc]")?"indirect":e.closest("[name=bcc]")?"undisclosed":"direct"}function k(e,t){const i=(0,s.zG)(n.ij(null==e?void 0:e.rt),n.tS((e=>n.ij(e.value))),n.UI((e=>({docid:e,containerType:"email",authors:(0,s.zG)(n.ij(y(e,t)),n.g_(s.r5,(e=>[e]))),audience:{recipients:C(e,t)},delta:I(e)})))),o=(0,s.zG)(n.ij(null==e?void 0:e.rm),n.tS((e=>n.ij(e.value))),n.UI((e=>({docid:e,containerType:"email",authors:(0,s.zG)(n.ij(y(e,t)),n.g_(s.r5,(e=>[e]))),parents:(0,s.zG)(i,n.g_(s.r5,(e=>[e]))),audience:{recipients:C(e,t)},delta:I(e)}))));return(0,s.zG)(o,n.wp((()=>i)),n.WG)}e.getRecipientsNodes=function(e){return x.slice(1).reduce(((t,i)=>t.length?t:e.querySelectorAll(i.recipientNodeSelector)),e.querySelectorAll(x[0].recipientNodeSelector))},e.getRecipientsFromComposeNodes=w,e.getRecipientsFromParentMessage=C,e.getAuthorFromParentMessage=y,e.getTextFromParentMessage=I,e.getAuthor=function(){var e;const t=x.reduce(((e,t)=>{if(e)return e;const i=document.querySelectorAll(t.authorNodeSelector);return i?i["first"===t.authorIndex?0:i.length-1]:null}),null);if(t){const i=Di.l((null===(e=t.attributes.getNamedItem("aria-label"))||void 0===e?void 0:e.value)||"");return i?{...i,currentSessionUser:!0}:null}return null},e.getAuthorDomain=function(){const t=e.getAuthor();return(null==t?void 0:t.email)?qe.X.getDomainFromEmail(t.email):null},e.getAuthorContextEventObservable=function(e){return(0,l.of)(e).pipe((0,p.h)(Re.fQ),(0,h.U)((e=>H.t.createDocContextUpdatedEvent({authors:[e]}))))},e.getRecipientKind=S,e.getRecipientsContextEventObservable=function(t,i){return Q.x.createUnsafe(t,{childList:!0,subtree:!0}).pipe((0,p.h)((e=>Array.from(e).some((e=>Array.from(e.removedNodes).filter((e=>"querySelector"in e)).some((e=>x.some((t=>e.querySelector(t.recipientNodeSelector)))))||Array.from(e.addedNodes).filter((e=>"getAttribute"in e)).some((e=>x.some((t=>e.matches(t.recipientNodeSelector))))))))),(0,h.U)((i=>e.getRecipientsNodes(t)))).pipe((0,f.O)(e.getRecipientsNodes(t)),(0,h.U)((e=>Array.from(e))),(0,h.U)((e=>w(e,i))),(0,g.d)({bufferSize:1,refCount:!0}))},e.getParentsContext=k,e.getParentsContextEventObservable=function(e,t){const i=k(e,t);return i?(0,l.of)(i).pipe((0,h.U)((e=>H.t.createDocContextUpdatedEvent({parents:[e]})))):null}}(Fi||(Fi={}));class Pi{constructor(e,t,i,r,a=E.Y.create("gmail.threadContext")){this._doc=e,this._expandedMessagesProvider=t,this._telemetry=r,this._logger=a,this._subscriptions=new o.w,this._state=k.h.create((0,s.zG)(function(e){const t=ae.fromNullable(new ze("Cannot find thread subject container"))(e.querySelector(qt));return{threadId:(0,s.zG)(t,ae.chain((e=>ae.fromNullable(new ze("Cannot find thread ID"))(e.getAttribute("data-thread-perm-id"))))),subject:(0,s.zG)(t,ae.chain((e=>ae.fromNullable(new ze("Cannot find thread Subject"))(e.textContent)))),loggedUser:(0,s.zG)(ae.fromNullable(new ze("Cannot extract user from avatar"))(Fi.getAuthor()),ae.chain((e=>(0,s.zG)(li.G.create(e.email),n.UI((t=>({name:e.name?e.name:void 0,email:t}))),ae.fromOption((()=>new ze("No email address found in avatar")))))))}}(this._doc),(e=>({threadId:e.threadId,subject:e.subject,loggedUser:e.loggedUser,expandedMessages:new Map,messageIndexToIdMap:new Map})))),this.threadContext=k.h.combine(this._state,this._expandedMessagesProvider.messageCount,((e,t)=>({...e,messageCount:t}))),(0,s.zG)(this._state.get(),(e=>Ae.Yt(ae.either)({threadId:e.threadId,subject:e.subject,loggedUser:e.loggedUser})),ae.mapLeft((e=>{this._telemetry.gmailThreadContext.warning("threadContextExtraction",e.message),this._logger.warn("Static thread context extraction error",e)}))),this._subscriptions.add((0,s.zG)(this._expandedMessagesProvider.expandedMessages,p.h((e=>e.added.size>0||e.updated.size>0||e.removed.size>0)),C.b((({added:e,updated:t,removed:i,messages:o})=>{this._logger.info(`Expanded messages changed - added [${Array.from(e).join(", ")}] - updated [${Array.from(t).join(", ")}] - removed [${Array.from(i).join(", ")}]`),this._state.modify((i=>({...i,expandedMessages:(0,s.zG)(o,de.DZ((o=>e.has(o.id)?n.G(Gi.x5):t.has(o.id)?(0,s.zG)(n.ij(i.expandedMessages.get(o.id)),n.UI((e=>Ge.VZ(e)||Ge.IR(e)?Gi.x5:e))):n.ij(i.expandedMessages.get(o.id))))),messageIndexToIdMap:new Map(Array.from(o.values()).map((({index:e,id:t})=>[e,t])))})))})),h.U((({added:e,updated:t,messages:i})=>(0,s.zG)(Array.from(e).concat(Array.from(t)),Pe.DZ((e=>n.ij(i.get(e)))),Pe.UI((e=>({id:e.id,index:e.index,messageNode:e.messageNode,bodyNode:e.bodyNode})))))),p.h((e=>e.length>0)),i,C.b((({message:{id:e,messageNode:t,bodyNode:i,index:n},context:o})=>this._state.lens("expandedMessages").modify((r=>new Map(r).set(e,(0,s.zG)(o,ae.fold((t=>{const i=`Could not extract context for #${e}: ${String(t)}`;return this._logger.warn(i),Gi.kH(new ze(i))}),(s=>(this._logger.trace(`Message #${e} extracted`),Gi.Vp({id:e,index:n,messageNode:t,bodyNode:i,context:s,textMap:Vi(i.node)}))))))))))).subscribe())}dispose(){this._subscriptions.unsubscribe()}}function Vi(e){const t="none"===(0,q.Jj)(e).getComputedStyle(e).display;return new $.Z(e,((e,t)=>$.Z.defaultFilterNodeAllowList(["PRE","CODE","BLOCKQUOTE"])(e,t)&&!G.maybeGmailHistoryQuote(e)),void 0,$.Z.isBlockNodeFromTagList((0,s.zG)(new Set($.Z.blockTags),Ai.Od(_e.yv)("CODE"))),void 0,void 0,((e,i)=>t||e instanceof Element&&"false"===e.getAttribute("aria-expanded")),G.gmailNodeFormatting,void 0,void 0,!1)}function Hi(e,t){return d.R((0,q.Jj)(e.documentElement),"popstate").pipe(f.O(null),He.g(50),b.w((()=>function(e,t){const i=new le.xQ;return i.pipe(f.O(null),b.w((()=>new r.y((i=>{t.trace("trying to find message list node");const n=e.querySelector(Dt);n?(t.debug("message list found",n),i.next(n)):i.error("Message list not found")})).pipe((0,Te.yF)(10,100,(()=>S.E)),oe.x(),b.w((n=>ri.n(n,{root:e}).pipe(h.U((e=>{const n=e.every((e=>e.isIntersecting));return n||(t.debug("message list disappeared"),i.next()),n})),pe.o((e=>!0===e)),m.h(n)))),oe.x()))))}(e,t).pipe(f.O(null)))),u.b(50),oe.x(),h.U(n.ij))}function Ki(e,t,i,n){const s=new ei(e),o=E.Y.create("gmail.threadContext"),r=Ii(t,i?Ni:()=>l.of([]),o);return{threadContextProvider:new Pi(t,s,r,n,o),expandedMessagesProvider:s}}class Wi extends Ve.J{constructor(e,t,i,a,d=U.OB,c=(0,Z.Tb)(),u=E.Y.create("gmail.threadContext.pageIntegration")){const g=new De.X(n.YP),p=(0,s.zG)(a,Pe.DZ((e=>e(g))));super(...p.map((e=>e.integration))),this._state=e,this._pageIntegrationContext=t,this._getEnv=d,this._telemetry=c,this._logger=u,this._subscriptions=new o.w,this._userChanged=new le.xQ;const m=p.some((e=>e.extractLinks));this._subscriptions.add((p.length>0?(0,s.zG)(Hi(this._pageIntegrationContext.doc,this._logger),b.w(n.g_((()=>l.of(n.YP)),(e=>new r.y((t=>{const o=()=>function(e,t,i,o,r,a){const{threadContextProvider:d,expandedMessagesProvider:c}=Ki(e,t.doc,i,a),l=(0,Re.Vo)((()=>(0,s.zG)(new nt({domain:t.domain,capiUrl:t.config.appConfig.url.capiStatic,supportedFeatures:o(),clientName:t.config.appConfig.capi.clientType,clientSubType:t.config.appConfig.capi.clientSubType,clientVersion:t.config.buildInfo.version,useDlp:Boolean(t.dynamicConfig.dlpEnabled)},r),(e=>({checkingService:e,adapter:new Le(e,d.threadContext)}))))),u=new Tt((0,s.zG)(d.threadContext.view((0,s.ls)(Ke.ei("expandedMessages"),de.DZ((0,s.ls)(be.xC,n.UI((e=>({docId:e.id,textMap:e.textMap,textNode:e.bodyNode})))))))),e);return{integrationContext:{messageList:e,threadContext:d.threadContext,expandedMessages:c.expandedMessages,checkingService:l.map((e=>e.adapter)),annotationsManager:u},dispose:e=>{d.dispose(),u.dispose(),l.hasValue&&(l.get().adapter.dispose(),l.get().checkingService.dispose(e))}}}(e,this._pageIntegrationContext,m,i,this._getEnv,this._telemetry),r=new De.X(o()),a=[this._userChanged.subscribe((()=>{r.value.dispose("User changed"),r.next(o())})),r.pipe(h.U((e=>n.G(e.integrationContext)))).subscribe(t)];return()=>{a.forEach((e=>e.unsubscribe())),r.value.dispose("Disposed")}})))))):S.E).subscribe(g)),this._logger.debug("Page integration created")}update(e){e.user.id===this._state.user.id&&e.user.type===this._state.user.type||this._userChanged.next(null),this._state=e,super.update(e)}dispose(){this._subscriptions.unsubscribe(),super.dispose(),this._logger.debug("Page integration disposed")}}function $i(e,t){return(0,s.zG)(Hi(e.field.ownerDocument,t),(0,p.h)((e=>(0,n.pC)(e))),(0,h.U)((({value:t})=>{const{threadContextProvider:i}=Ki(t,e.field.ownerDocument,!0,e.felog);return i})),(0,b.w)((t=>new r.y((i=>{const n=new o.w;return n.add(Fe((t=>{e.felog.gmailThreadContext.warning("getDocumentContext",t.message)}),(0,l.of)(!0),t.threadContext).subscribe((({docInfo:e})=>i.next(e)))),()=>{n.unsubscribe(),t.dispose()}})))),(0,h.U)((e=>Bi(e))))}function Bi(e){var t,i;return{...e,docId:Yi(e.docId),audience:{...e.audience,channelId:(null===(t=e.audience)||void 0===t?void 0:t.channelId)?Yi(e.audience.channelId):void 0},siblings:null===(i=e.siblings)||void 0===i?void 0:i.map(Bi)}}function Yi(e){return e.startsWith("#")?e:`#${e}`}!function(e){let t;const b={cheetahOverflowCustomCaret:!0,cheetahEnableQuickReplies:!0};function w(e,n,s,a,d){if(D.d.shouldCreate(a.config.bundleInfo.browser,a.domain,s.dynamicConfig,s.user)){const s=new o.w;return new r.y((o=>{o.next(null),i.e(4100).then(i.bind(i,89182)).then((({ProofitGmailInProgressRequestTracker:i,ProofitGmailIntegrationForComposeWindow:r,ProofitGmailIntegrationForThreads:a})=>{t||(t=new i);const c=new("composeWindow"===d?r:a)(e,n,t);return o.next(c.getProofitLayout()),s.add(Q.x.observeStyle(e).pipe((0,u.b)(200),(0,h.U)((()=>c.getProofitLayout()))).subscribe((e=>o.next(e)))),()=>s.unsubscribe()}))})).pipe((0,g.d)())}}const C=e=>!!e.state.dynamicConfig.confidentialModeEnabled&&Fi.isInConfidentialMode(e.field),y=e=>()=>(0,a.T)((0,d.R)(e.field,"focus").pipe((0,p.h)((()=>C(e)))),(0,V.Jj)(e.field)).pipe((0,m.h)(void 0)),I=(e,t)=>P.T.contentEditable("Gmail.compose",(i=>{const n=Fi.getComposeFieldContainer(i.field);return{integrationName:t,extraCondition:t=>e(t.field)&&!C(t),expiration:y(i),createLayout:e=>{const t=w(e,n,i.state,i.pageContext,"composeWindow"),s="show"===i.state.dapi.emogenieEmojiState,o=T.V.getTotalWidth(T.V.gButtonMaxSize,s)+8,r=(0,O.Cq)((n||i.field).closest("table")),a=Fi.createToolbarVisibleObservable(r),d=Fi.createAttachmentsListObservable(r);return new F.A(n||i.field,{gbuttonMinPadding:6,proofitLayout:t,createGbuttonShiftBehavior:e=>{const t=(0,c.aj)([a,e.rect.behavior],((e,t)=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return t.size.width-i.width-4<o?i.height+(i.bottom-t.client.top-t.size.height):0}return 0})),i=(0,c.aj)([Fi.attachmentsMetricsObservable(d,e.rect.behavior,a),e.rect.behavior,e.scroll.behavior],((e,t,i)=>t.size.height-e.top+i.top>0&&t.size.width-e.width-4<o?t.size.height-e.top+i.top+4:0));return(0,c.aj)([t,i],((e,t)=>Math.max(e,t))).pipe((0,h.U)((e=>({top:-e,left:0}))),(0,g.d)())},injectIntegrationRoot:({editorElement:e,integrationRoot:t})=>{var i;null===(i=e.parentElement)||void 0===i||i.appendChild(t)},getScrollValue:e=>({top:e.scrollTop,left:i.field.scrollLeft}),vBarsUIInjectionCustomizations:v})},textMap:{createFieldTextMap:G.createTextMap},customizations:{richText:R.kn.isAvailable(i),applyFormatting:!0,getDocumentId:()=>{var e,t,n;const s=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form");return(null===(t=null==s?void 0:s.draft)||void 0===t?void 0:t.value)?(0,M.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var e;const t=null===(e=i.field.closest('table[role="presentation"]'))||void 0===e?void 0:e.querySelector("form"),n=Fi.getAuthor(),s=Fi.getAuthorContextEventObservable(n),o=(0,B.c)(null==t?void 0:t.subjectbox).pipe((0,u.b)(300),(0,h.U)((e=>H.t.createDocContextUpdatedEvent({title:e}))),(0,g.d)({bufferSize:1,refCount:!0})),r=t?Fi.getRecipientsContextEventObservable(t,n).pipe((0,h.U)((e=>H.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,d=Fi.getSubmitObservable(i.field,r).pipe((0,h.U)(H.t.createPublishedEvent)),c=t?Fi.getParentsContextEventObservable(t,n):null;return(0,a.T)(d,s,o,...r?[r]:[],...c?[c]:[])},...b},onCreate:Fi.hideNativeSuggestions,onDispose:()=>{Fi.showNativeSuggestions()},getFromEmailDomainAndSignature:e=>se(e)}})),S=I(Fi.isCompose,ee.u.gmailCompose),k=I(Fi.isFullscreenCompose,ee.u.gmailComposeFullScreen),U=I(Fi.isStandaloneCompose,ee.u.gmailComposeStandalone);const N=P.T.contentEditable("Gmail.reply",(e=>{const t=E.Y.create("gmail.reply.pageIntegration"),i=e.experimentClient.isGateEnabled(X.K.TrackSiblingDataForGMail);return{integrationName:ee.u.gmailReply,extraCondition:e=>Fi.isComposeReply(e.field)&&!C(e),expiration:y(e),createLayout:()=>function(e,t,i){const n=e.closest("table"),s=null==n?void 0:n.closest("table:not(:scope)"),o=null==s?void 0:s.querySelector('[command="Files"]'),r=null==o?void 0:o.closest("table"),a=(null==r?void 0:r.closest("div"))||null,l=(0,O.Cq)(e.offsetParent&&e.offsetParent.nodeType===Node.ELEMENT_NODE?"TD"===e.offsetParent.nodeName?n:e.offsetParent:null),u=(0,q.wr)(e,(e=>!!e.id&&"scroll"===(0,q.o)(e).overflowY))||e,p=(0,L.z)(u),m=(0,O.Cq)(e.closest("[role=listitem]")),b=w(e,l,t,i,"threads"),_=Fi.createToolbarVisibleObservable(m),v=Fi.createAttachmentsListObservable(m),x="show"===t.dapi.emogenieEmojiState,C=14,y=T.V.getTotalWidth(T.V.gButtonMaxSize,x)+4;return new F.A(e,{scroller:p,proofitLayout:b,customGbuttonPositioning:{injectionElement:a,createPositionStyleBehavior:e=>e.pipe((0,h.U)((e=>({position:"absolute",transform:"translate(0, -100%)",width:"auto",height:"auto",pointerEvents:"all",right:C-e.left+"px",top:`${-14+e.top}px`})))),injectionStyle:{top:"0",left:"auto",right:"0"},calculateMetrics:(e,t,i)=>{const n=j.p8.create({top:i.top-C,left:e.size.width+i.left-C});return{offset:n,page:j.Cv.fromOffset(n,j.Cv.fromClient(e.client,{top:t.scrollY,left:t.scrollX}),{top:0,left:0}),client:j.Ir.create(j.E9.plus(e.client,n)),effectivePadding:{top:0,right:0,bottom:0,left:0},size:T.V.gButtonMaxSize}},createShiftBehavior:(e,t)=>{const i=(0,c.aj)([_,e.behavior]).pipe((0,h.U)((([e,t])=>{if(e&&e.visible&&e.el){const i=e.el.getBoundingClientRect();return i.left+i.width+4>t.client.left+t.size.width-y-C?t.client.top-i.top:0}return 0}))),n=(0,c.aj)([Fi.attachmentsMetricsObservable(v,t.rect.behavior,_),t.rect.behavior,e.behavior,(0,d.R)(u,"scroll").pipe((0,f.O)(null))]).pipe((0,h.U)((([i,n,s,o])=>{if(i.top){const n=t.rect.getCurrent(),s=e.getCurrent(),o=s.client.left+s.size.width-y-C;return i.top&&n.client.left+i.width>o&&n.client.top+i.top<s.client.top?s.client.top-(n.client.top+i.top):0}return 0})));return(0,c.aj)([i,n]).pipe((0,h.U)((([e,t])=>Math.max(e,t)))).pipe((0,h.U)((e=>({top:-e,left:0}))),(0,f.O)({top:0,left:0}),(0,g.d)())}}})}(e.field,e.state,e.pageContext),textMap:{createFieldTextMap:G.createTextMap},onCreate:Fi.hideNativeSuggestions,onDispose:Fi.showNativeSuggestions,customizations:{richText:R.kn.isAvailable(e),applyFormatting:!0,getDocumentId:e=>{var t,i,n;const s=null===(t=e.closest('table[role="presentation"]'))||void 0===t?void 0:t.querySelector("form");return(null===(i=null==s?void 0:s.draft)||void 0===i?void 0:i.value)?(0,M.m3)(null===(n=null==s?void 0:s.draft)||void 0===n?void 0:n.value):void 0},getContainerType:()=>"email",getDocEvents:()=>{var n;const s=Fi.getAuthor(),o=Fi.getAuthorContextEventObservable(s),r=null===(n=e.field.closest('table[role="presentation"]'))||void 0===n?void 0:n.querySelector("form"),d=r?Fi.getRecipientsContextEventObservable(r,s).pipe((0,h.U)((e=>H.t.createDocContextUpdatedEvent({audience:{recipients:e,indirectRecipients:e.filter((e=>"indirect"===e.kind)),undisclosedRecipients:e.filter((e=>"undisclosed"===e.kind))}})))):null,c=Fi.getSubmitObservable(e.field,d).pipe((0,h.U)(H.t.createPublishedEvent)),u=r?Fi.getParentsContextEventObservable(r,s):null,g=(null==r?void 0:r.subject)?(0,l.of)(String((null==r?void 0:r.subject.value)||"")).pipe((0,h.U)((e=>H.t.createDocContextUpdatedEvent({title:e})))):null,p=i?$i(e,t).pipe((0,h.U)(H.t.createDocContextUpdatedEvent)):null;return(0,a.T)(...[c,o,g,d,u,p].filter((e=>!!e)))},...b},getFromEmailDomainAndSignature:e=>se(e)}})),$=(0,K.$W)({name:"gmail",domain:Y.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table"),eventPropagationHandler:e=>{(0,J.E)().experimentClient.isGateEnabled(X.K.CentralizeStopEventPropagation)||e.addEventListener("keypress",(e=>{e.stopPropagation()}))}},[N,k,U,S,W.k.iframeHostRule]),te=(0,K.AY)({name:"gmail-general-purpose",domain:Y.ki,pathname:/^\/mail\/.*$/,andCanExecute:e=>!e.doc.querySelector("body>table")&&(0,x.c)(e.experimentClient)},[(e,t,i,o)=>new Wi(t,e,(()=>[...(0,x.c)(e.experimentClient)?[_.z.knowledgeHub]:[]]),[r=>(0,s.zG)((0,x.c)(e.experimentClient),(e=>e?n.G({integration:new A(r,o,t,i,(0,Z.Tb)())}):n.YP))])],"gmail-general-purpose-page-integration-rule"),ie=(0,K.$W)({name:"gmail-chat",domain:Y.ki,pathname:/^\/chat\/.*$/},[W.k.iframeHostRule,...W.k.newLayoutRules]),ne=(0,K.$W)({name:"gmail-feedback",andCanExecute:e=>{var t,i,n;return(0,z.n_)()&&"google-feedback-iframe"===(null===(n=null===(i=null===(t=e.doc)||void 0===t?void 0:t.defaultView)||void 0===i?void 0:i.frameElement)||void 0===n?void 0:n.getAttribute("id"))}},[P.T.textarea("Gmail.feedback",(e=>({createLayout:()=>new F.A(e.field,{}),extraCondition:()=>!1})))]);function se(e){return{fromEmailDomain:Fi.getAuthorDomain(),emailSignature:qe.X.getSignature(e)}}e.pages=[$,ie,ne],e.generalPurpose=[te]}(qi||(qi={}))},22236:(e,t,i)=>{i.d(t,{X:()=>n});var n,s=i(18820);!function(e){e.getSignature=function(e){const t=[];e.getRichText().eachLine(((e,i)=>(!0===i.signature&&t.push(e),!0)));const i=t.map((e=>e.ops.reduce(((e,t)=>s.s.isInsertString(t)&&t.insert?e+t.insert:e),"")));return i.length?i.join(";"):null},e.getDomainFromEmail=function(e){const t=e.indexOf("@");return t>=0?e.substring(t+1):null}}(n||(n={}))},65233:(e,t,i)=>{i.d(t,{c:()=>c});var n=i(64965),s=i(8748),o=i(65647),r=i(55446),a=i(60165),d=i(14765);function c(e){const t=e||null;return t?(0,n.R)(t,"input").pipe((0,o.U)((e=>e.target)),(0,r.h)((e=>e===t)),(0,o.U)((e=>e.value)),(0,a.x)(),(0,d.O)(t.value)):s.E}},11338:(e,t,i)=>{i.d(t,{l:()=>o});var n=i(90023),s=i(58303);function o(e){const t=e.split("Google");return(0,n.zG)(s.ij(t[1]),s.UI((e=>{const t=e.split(":");return t.length>1?t[1]:t[0]})),s.g_(n.gn,(e=>{const t=/^(.*?)\s*\n\((.+)\).*$/.exec(e);return t?{name:t[1].trim(),email:t[2].trim()}:null})))}}}]);